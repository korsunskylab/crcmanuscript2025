---
title: "Figure 2 - Luminal surface shows evidence of inflammation and tissue remodeling."
author: "CRC MERFISH Project"
date: today
format:
  html:
    toc: true
    code-fold: true
    embed-resources: true
    crossref:
      fig-title: ""
  pdf:
    documentclass: article
    crossref:
      fig-title: ""
execute:
  echo: true
  warning: false
  message: false
  cache: false
---

```{r}
#| label: setup
#| echo: true
#| message: false
#| warning: false
#| results: hide
#| cache: false

source(here::here("src/rload.R"))
```

```{r}
#| label: helper-functions
#| echo: true
#| results: hide

plot_deg_volcano <- function(ggdf_deg, add_genes_to_label) {
  gene_check <- add_genes_to_label[add_genes_to_label %out% ggdf_deg$Gene_ID]
  if (length(gene_check) > 0){
    cat("Check the spelling of the following genes: \n")
    cat(gene_check)
    cat("\n")
  }
  
  plt <- ggdf_deg %>%
    mutate(
      fill_col = case_when(
        padj <= 0.05 & Pass_NeighborCell_Filter == TRUE ~ "sig",
        padj <= 0.05 & Pass_NeighborCell_Filter == FALSE ~ "sig_false",
        padj > 0.05 ~ "ns",
        TRUE ~ "ns"
      )
    ) %>%
    ggplot(mapping = aes(x = log2FoldChange, y = -log10(padj))) +
    geom_hline(
      yintercept = -log10(0.05),
      linewidth = 0.5, linetype = "dashed", color = "black",
    ) +
    geom_vline(
      xintercept = 0,
      linewidth = 0.5, linetype = "dashed", color = "black",
    ) +
    geom_point(
      mapping = aes(fill = fill_col),
      shape = 21,
      size = 1.25, stroke = 0.25
    ) +
    ggrepel::geom_text_repel(
      . %>% filter(Gene_ID %in% add_genes_to_label),
      mapping = aes(label = Gene_ID),
      size = 2,
      max.overlaps = Inf
    ) +
    scale_fill_manual(
      values = c(
        "sig" = "firebrick",
        "sig_false" = "white",
        "ns" = "black"
      )
    ) +
    labs(
      x = "logFC",
      y = "-log10(adj)"
    ) +
    theme(legend.position = "none")

  return(plt)
}

plot_pseudobulk_boxplot <- function(ggdf_gex, res_DEG, genes_to_plot) {
  ggdf <- ggdf_gex %>%
    pivot_longer(
      cols = -c("Patient_ID", "MMRstatus", "pathology_region"),
      names_to = "Gene_ID",
      values_to = "value"
    ) %>%
    filter(Gene_ID %in% genes_to_plot) %>%
    mutate(
      Gene_ID = factor(Gene_ID, levels = genes_to_plot),
      pathology_region = factor(pathology_region, levels = c("tumor", "tumor_luminal_margin"))
    )

  max_gex <- ggdf %>%
    group_by(Gene_ID) %>%
    summarize(max_gex = max(value, na.rm = TRUE), .groups = "drop")

  ggdf_stat <- ggdf_deg %>%
    filter(Gene_ID %in% genes_to_plot) %>%
    mutate(
      group1 = "tumor",
      group2 = "tumor_luminal_margin"
    ) %>%
    left_join(
      max_gex,
      by = c("Gene_ID")
    ) %>%
    mutate(
      y.position = case_when(
        (group1 == "tumor") & (group2 == "tumor_luminal_margin") ~ max_gex * 1.1,
        TRUE ~ max_gex * 1.05
      ),
      padj_format = format(signif(padj, 2), scientific = TRUE),
      Gene_ID = factor(Gene_ID, levels = genes_to_plot)
    ) %>%
    filter(!is.na(y.position))

  plt <- ggplot() +
    geom_boxplot(
      ggdf,
      mapping = aes(x = pathology_region, y = value),
      outlier.shape = NA,
      lwd = 0.5, median.linewidth = 0.5
    ) +
    geom_line(
      ggdf,
      mapping = aes(x = pathology_region, y = value, group = Patient_ID, color = MMRstatus),
      linewidth = 0.5, alpha = 0.5
    ) +
    geom_point(
      ggdf,
      mapping = aes(x = pathology_region, y = value, fill = MMRstatus),
      shape = 21,
      size = 1.25, stroke = 0.15
    ) +
    stat_pvalue_manual(
      ggdf_stat,
      label = "padj_format",
      tip.length = 0.01,
      size = 2
    ) +
    facet_wrap(
      ~Gene_ID,
      scales = "free_y", ncol = 6,
      labeller = labeller(Gene_ID = function(value) {
        wrapped_labels <- label_wrap_gen(width = 13)(gsub("-", " ", value))
        return(wrapped_labels)
      })
    ) +
    scale_x_discrete(labels = c("Tumor", "Tumor\nLS")) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
    scale_color_manual(values = cmap_MMR) +
    scale_fill_manual(values = cmap_MMR) +
    coord_cartesian(ylim = c(0, NA)) +
    labs(
      x = NULL,
      y = "GEX"
    ) +
    vertical_x_text() +
    theme(legend.position = "none")

  return(plt)
}
```

## Figure 2A
```{r}
#| label: fig-1a
#| fig-width: 6
#| fig-height: 4

# Made in Adobe Illustrator
knitr::include_graphics("../figures_ai/Fig2A.png")
```

## Figure 2B

```{r}
#| label: fig-2b
#| fig-width: 7.25
#| fig-height: 3
#| fig-dpi: 300

glmm_res <- fread(here(
  outdir,
  "GLMM_tables",
  "GLMM_pathology_region_tumor_luminal_margin_vs_intratumoral_region.csv"
))

plt <- plot_glmm_barplot(glmm_res)

plt
```

## Figure 2C
Data by Jingya
```{r}
#| label: fig-2c
#| fig-width: 2.5
#| fig-height: 4.6
#| fig-dpi: 300

ggdf_deg <- readxl::read_excel(
  here(
    "data/supplemental_tables",
    "Supp Table 4 - Luminal Surface DEG Fig 2.xlsx"
  ),
  sheet = "Table S4A - MonoMac - DEG"
)
add_genes_to_label <- c("GPNMB", "ALOX5", "MSR1")
# add_genes_to_label <- ggdf_deg %>%
#   filter(padj <= 0.05 & Pass_NeighborCell_Filter == TRUE) %>%
#   pull(Gene_ID)
add_genes_to_label <- c(
  "GPNMB", "ALOX5", "CXCL12", "MSR1", "PTGS2", "CXCL3", "IL1B",
  "VEGFA", "CXCL8", "FOSB", "IL1A", "EREG", "CXCL2", "IL1RAP",
  "CXCL5", "CXCL1", "CD69", "TNFRSF9")

ggdf_gex <- readxl::read_excel(
  here(
    "data/supplemental_tables",
    "Supp Table 4 - Luminal Surface DEG Fig 2.xlsx"
  ),
  sheet = "Table S4B - MonoMac - VST"
)
genes_to_plot <- c("PTGS2", "CXCL3", "VEGFA")

plt1 <- plot_deg_volcano(ggdf_deg, add_genes_to_label) +
  ggtitle("Monocytes and Macrophages")
plt2 <- plot_pseudobulk_boxplot(ggdf_gex, ggdf_deg, genes_to_plot)

plt <- plt1 + plt2 +
  plot_layout(heights = c(1, 0.65))

plt
```

## Figure 2D
Data by Jingya
```{r}
#| label: fig-2d
#| fig-width: 2.5
#| fig-height: 4.5
#| fig-dpi: 300
ggdf_deg <- readxl::read_excel(
  here(
    "data/supplemental_tables",
    "Supp Table 4 - Luminal Surface DEG Fig 2.xlsx"
  ),
  sheet = "Table S4C - Fibro - DEG"
)
add_genes_to_label <- c(
  "TIMP1", "HEY1", "IGFBP3", "CXCL5", "MMP3", "IL1B", "PTGS2", "CXCL6",
  "CCL8", "IL24", "MMP1", "CXCL8", "CCL2"
)

ggdf_gex <- readxl::read_excel(
  here(
    "data/supplemental_tables",
    "Supp Table 4 - Luminal Surface DEG Fig 2.xlsx"
  ),
  sheet = "Table S4D - Fibro - VST"
)
genes_to_plot <- c("CXCL5", "MMP3", "IL24")

plt1 <- plot_deg_volcano(ggdf_deg, add_genes_to_label) +
  ggtitle("Fibroblasts")
plt2 <- plot_pseudobulk_boxplot(ggdf_gex, ggdf_deg, genes_to_plot)

plt <- plt1 + plt2 +
  plot_layout(heights = c(1, 0.65))

plt
```

## Figure 2E
Data by Jingya
```{r}
#| label: fig-2e
#| fig-width: 2.5
#| fig-height: 4.5
#| fig-dpi: 300
#|
ggdf_deg <- readxl::read_excel(
  here(
    "data/supplemental_tables",
    "Supp Table 4 - Luminal Surface DEG Fig 2.xlsx"
  ),
  sheet = "Table S4E - Endo - DEG"
)
# add_genes_to_label <- ggdf_deg %>%
#   filter(padj <= 0.05 & Pass_NeighborCell_Filter == TRUE) %>%
#   pull(Gene_ID)
add_genes_to_label <- c(
  "VEGFC", "ADGRG6", "SELP", "HEY1", "SEMA3G",
  "MMP1", "CCL2", "CSF3", "APLN", "CXCL8", "CXCL1",
  "ANGPT2", "OLFM4", "TNFRSF4", "SERPINE1", "CD69", "UBE2C",
  "S100A9", "ESM1"
)

ggdf_gex <- readxl::read_excel(
  here(
    "data/supplemental_tables",
    "Supp Table 4 - Luminal Surface DEG Fig 2.xlsx"
  ),
  sheet = "Table S4F - Endo - VST"
)
genes_to_plot <- c("CSF3", "APLN", "CCL2")

plt1 <- plot_deg_volcano(ggdf_deg, add_genes_to_label) +
  ggtitle("Endothelial cells")
plt2 <- plot_pseudobulk_boxplot(ggdf_gex, ggdf_deg, genes_to_plot)

plt <- plt1 + plt2 +
  plot_layout(heights = c(1, 0.65))

plt
```

## Figure 2F

```{r}
#| label: fig-2f
#| fig-width: 6
#| fig-height: 4
knitr::include_graphics("../figures_ai/Fig2F.png")
knitr::include_graphics("../outputs/sample_viz/Fig2F_G4423_luminal_margin.png")
```
