# Project title: Immunity hubs in colorectal cancer identified by spatial profiling

## Conda environment:
- r-analysis-env.yml: Conda environment to run the Jupyter notebooks

## Folders and what's in them:

### For figure 1:
- HE images: pathology annotation transfer missing, coordinate with pelka
- Raw data from VIZGEN:
-- Each folder corresponds to a sample
-- cellpose_tx_annotation.csv: detected transcripts
-- cellpose_micron_space.parquet: open with R sf, contains cell shape polygons
- Baysor segmentation: We segmented cells using Baysor 0.7.0 (https://github.com/kharchenkolab/Baysor). This contains raw Baysor output - assignation of tx to cells, cell polygons, cell by gene matrices. It also contains cellpose annotations for each detected transcripts, and a parquet file containing cellpose cell shapes. We use the cellpose annotations (generated by Vizgen) as input to Baysor. Parameters documented in the manuscript.
- **TO DO: Ask Pelka lab for the script that merges cells between tiles that we used for Baysor segmentation.**
- Pathology annotations:
-- final annotations are in pathology_regions_postQC.csv
-- luminal and invasive margin definitions/code: request from pelka lab
-- figure2.ipynb: code to generate visualizations
-- Fig 1j: request from pelka lab 
- Labeled MERFISH data: MERFISH cells labeled by cell state
- Harmony and UMAP embeddings of MERFISH data
- Cleaned scRNA references for cell typing
- Cell typing: Label transfer from a cleaned scRNA reference to the MERFISH dataset. Contains two sections: coarse typing (step 1) and fine typing (step 2). After fine typing, we found markers using a GLMM for each cell state in each sample, then combined them using a meta analysis (in folder 'meta_analysis_cluster_markers'). In the folder 'Harmonize all MERFISH' - code t harmonize all MERFISH samples togetehr for the tessera tile analysis. 
  Imputed counts: we inferred data for all genes for our MERFISH cells, using the scRNA atlas

### NOTE: Figure 2: request from pelka lab

### Figure 3:
- We segmented tissues using an early version of Tessera (Stein, Tran, Korsunsky 2025). Avoid redoing this, since this was made with an early/inhouse version of Tessera. (Find these results in 'Tessera tiles/Tessera raw results'). Can ask I. Korsunsky for parameters. 
- - CXCR3L mask annotations: Annotation of CXCL9/10/11 expressing regions. Definition of CXCL9/10/11 mask **TO DO: Ask Pelka lab for code where they generated the mask**
- Tessera tiles: Raw and processed Tessera tiles.
- Tessera_analysis_for_sharing.ipynb (need to migrate this to Tessera tiles folder): code for identifying tissue regions

### Figure 4:
Interface analysis: distribution of cell states and genes around interfaces between tumor and stromal regions in tumor samples (Figure 4)
- Step 0: construct interface
- Step 1: Compare the cell states around MSI and MSS interfaces
- Step 2: Compare the cell states around Hub+ and Hub- interfaces
- Other notebooks: spatial patterns of gene expression around the interfaces
- Lots of other files: images etc

### Figure 5: 
- Colocalization of Tessera tiles around the interface: colocalization of cell states with each other around the interface (Figure 5)
- Fig 5 D and E - **TO DO request from Pelka lab**

### Figure 6: request from the Pelka lab




